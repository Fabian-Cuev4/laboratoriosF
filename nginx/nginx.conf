events { 
    worker_connections 1024; 
}

http {
    # --- 1. LEAST CONNECTIONS (El Solidario) ---
    upstream backend_least {
        least_conn; 
        server laboratorios-backend-1:8000;
        server laboratorios-backend-2:8000;
        server laboratorios-backend-3:8000;
    }

    # --- 2. IP HASH (El Fiel) ---
    upstream backend_ip {
        ip_hash;
        server laboratorios-backend-1:8000;
        server laboratorios-backend-2:8000;
        server laboratorios-backend-3:8000;
    }

    # --- 3. URI HASH (El Bibliotecario - Caché) ---
    # La clave consistente es la URI ($request_uri)
    upstream backend_uri {
        hash $request_uri consistent;
        server laboratorios-backend-1:8000;
        server laboratorios-backend-2:8000;
        server laboratorios-backend-3:8000;
    }

    # --- 4. RANDOM (La Lotería) ---
    upstream backend_random {
        random;
        server laboratorios-backend-1:8000;
        server laboratorios-backend-2:8000;
        server laboratorios-backend-3:8000;
    }

    # --- 5. RANDOM TWO (El Híbrido Inteligente) ---
    # Elige 2 al azar y se queda con el que tenga menos conexiones
    upstream backend_random_two {
        random two least_conn;
        server laboratorios-backend-1:8000;
        server laboratorios-backend-2:8000;
        server laboratorios-backend-3:8000;
    }

    server {
        listen 80;

        # Headers CORS permisivos para desarrollo
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization' always;
        add_header 'Access-Control-Max-Age' '86400' always;

        # Manejar preflight requests (OPTIONS)
        if ($request_method = 'OPTIONS') {
            return 204;
        }

        # RUTA POR DEFECTO (Usa Least Conn porque es el más sensato)
        location / {
            proxy_pass http://backend_least;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # === RUTAS DE DEMOSTRACIÓN PARA EL PROFE ===

        # Prueba 1: http://localhost:8001/demo/least/
        location /demo/least/ {
            rewrite ^/demo/least/(.*) /$1 break;
            proxy_pass http://backend_least;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Prueba 2: http://localhost:8001/demo/ip/ (Dale F5, no cambia de server)
        location /demo/ip/ {
            rewrite ^/demo/ip/(.*) /$1 break;
            proxy_pass http://backend_ip;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Prueba 3: http://localhost:8001/demo/uri/ (Cambia solo si cambias la URL)
        location /demo/uri/ {
            rewrite ^/demo/uri/(.*) /$1 break;
            proxy_pass http://backend_uri;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Prueba 4: http://localhost:8001/demo/random/ (Totalmente al azar)
        location /demo/random/ {
            rewrite ^/demo/random/(.*) /$1 break;
            proxy_pass http://backend_random;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Prueba 5: http://localhost:8001/demo/two/ (Matemáticamente superior)
        location /demo/two/ {
            rewrite ^/demo/two/(.*) /$1 break;
            proxy_pass http://backend_random_two;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}